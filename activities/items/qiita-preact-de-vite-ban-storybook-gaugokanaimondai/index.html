<!doctypehtml><html lang="ja"><title>zk-phi の部屋 :: 最近の活動</title><meta charset="utf-8"><meta name="viewport"content="initial-scale=1"><meta name="description"content="zk-phi のホームページです"><link rel="preload"href="/fonts/DotGothic16-Regular.woff"as="font"crossorigin><link rel="stylesheet"href="/css/font.css"><link rel="stylesheet"href="/css/common_critical.css"><link rel="stylesheet"href="/css/activity.css"><script defer src="/js/loader.js"></script><style></style><body id="body"><div id="content"><h1 id="title"><span class="rot">💻</span>最近の活動<span class="rot">💻</span></h1><p><a class="link"href="javascript:history.back()">&lt; 戻る</a><hr class="hr"><div id="article"class="left"><h2>Preact で Vite 版 Storybook が動かない問題</h2><div class="right"><p>Qiita (2022/4/2)<a class="link"target="_blank"rel="noreferrer"href="https://qiita.com/zk_phi/items/70832659bddd01cba058">See original</a></div><div id="cdata"><h1>問題</h1><p>記事投稿時点では、 Preact のプロジェクトに<pre><code class="language-terminal">npx sb init --builder storybook-builder-vite
</code></pre><p>で Storybook を入れてもうまく表示されません。その対症療法を書き残しておきます。<h1>@mdx-js/preact のバージョン</h1><p><code>.mdx</code>形式の story を表示するために必要なライブラリ<code>@mdx-js/preact</code>が自動では入らないので、入れる必要があります。<p>しかも<code>@mdx-js/preact</code>はつい最近メジャーバージョンが変わったようで、最新を入れても動きません。メジャーバージョンが変わる直前のバージョンを入れる必要があります。<pre><code class="language-terminal">npm install --save-dev @mdx-js/preact@1.6.22
</code></pre><h1>Vite の設定</h1><p>加えて、<code>@storybook/preact</code>が Vite に対応していないため、 Vite のビルドオプションをこちらで設定してやる必要があります。<p><code>storybook-builder-vite</code>を使用している場合、<code>.storybook/main.js</code>の<code>viteFinal</code>で Vite に渡すオプションを設定することができます。<p>最小の設定は以下になります。<pre><code class="language-diff"> module.exports = {
   ...,
+  viteFinal: (config) =&gt; ({
+    ...config,
+    esbuild: {
+      jsxFactory: &quot;h&quot;,
+      jsxFragment: &quot;Fragment&quot;
+    },
+    resolve: {
+      alias: {
+        &quot;react-dom&quot;: &quot;preact/compat&quot;,
+        react: &quot;preact/compat&quot;
+      }
+    }
+  })
}
</code></pre><p>JSX を<code>h</code>,<code>Fragment</code>関数に変換すること、 React 特有の関数を<code>preact/compact</code>で代用することを指定します。<p>story ファイルでいちいち<code>import { h } from 'preact';</code>するのが面倒な場合は、さらに以下の行を追加することで勝手に import してくれます。<pre><code class="language-diff">       jsxFactory: &quot;h&quot;,
       jsxFragment: &quot;Fragment&quot;,
+      jsxInject: `import { h, Fragment } from &quot;preact&quot;`
</code></pre></div></div><hr class="hr"><p><a class="link"href="javascript:history.back()">&lt; 戻る</a></div><script>const lazyScripts=["/js/prefetch.js","/js/stalker.js","/js/activity.js"],lazyStyles=["/css/common.css","/css/stalker.css"]</script>