<!doctypehtml><html lang="ja"><title>zk-phi の部屋 :: 最近の活動</title><meta charset="utf-8"><meta name="viewport"content="initial-scale=1"><meta name="description"content="zk-phi のホームページです"><link rel="preload"href="/fonts/DotGothic16-Regular.woff2"as="font"crossorigin><link rel="stylesheet"href="/css/font.css"><link rel="stylesheet"href="/css/common_critical.css"><link rel="stylesheet"href="/css/activity.css"><script defer src="/js/loader.js"></script><style></style><body id="body"><div id="content"><h1 id="title"><span class="rot">💻</span>最近の活動<span class="rot">💻</span></h1><p><a class="link"href="javascript:history.back()">&lt; 戻る</a><hr><div id="article"class="left"><h2>auto-complete から company に移行した</h2><div class="right"><p>Qiita (2020/12/3)<a class="link"target="_blank"rel="noreferrer"href="https://qiita.com/zk_phi/items/9dc373e734d20cd31641">See original</a></div><div id="cdata"><p><a href="https://qiita.com/advent-calendar/2020/emacs">Emacs Advent Calendar 2020</a>の 4 日目の記事です。<p>12/8：<code>company-tng</code>の存在を教えてもらったので追記しました<h2>なにをやったの</h2><p>Emacs のリアルタイム補完エンジン二大巨頭として auto-complete, company があると思いますが、私は Emacs を使い始めた頃からずっと auto-complete のお世話になっていました。<p>しかし最近は company の方が開発が活発になりつつある印象もあるので、思い切って company に切り替えてみました。<p>移行してみたざっくり感想ですが、いいところとしては：<ul><li>やや動作が軽い<li>backend, frontend, transformer など補完エンジンの各パーツがプラガブルな設計になっていて良い</ul><p>いまいちなところとしては：<ul><li>auto-complete に慣れていると、細かいところで不親切というか違和感を感じるところはある</ul><p>と思いました。<p>後者について、それぞれの気になりポイントと、それに対する私の設定を紹介します。 auto-complete 側の機能を移植するプラグインもいくつか作ってみました。<p>すでに company ユーザーな方にもちょっと役立つところもあるかもしれません。<h2>基本設定</h2><h3>company-require-match</h3><p>補完候補の選択を始めると（？）、補完候補にない文字が打てないようになる仕組みがあるっぽいです。いまいちありがたさを感じなかった＆違和感があったので、無効にしました<pre><code class="language-emacs-lisp">(setq company-require-match 'never)
</code></pre><h3>その他</h3><p>その他の設定項目も auto-complete を使用していた時と同じような使用感になるように設定しました。<pre><code class="language-emacs-lisp">(setq company-idle-delay 0
      company-minimum-prefix-length 2
      company-selection-wrap-around t
      company-tooltip-align-annotations t)
</code></pre><h2>company-statistics</h2><p>auto-complete には補完候補を使用頻度に応じていい感じに並べてくれる仕組み (<code>ac-comphist</code>) がありましたが、 company にはなかったので相当するプラグインを入れました。<pre><code class="language-emacs-lisp">(require 'company-statistics)

(setq company-statistics-file my-company-history-file
      company-transformers
      '(company-sort-by-statistics company-sort-by-backend-importance))

(company-statistics-mode)
</code></pre><h2>company-dwim</h2><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/29d6b550-cbf4-9b2e-d99b-7cc6020b3985.gif"alt="screencast.gif"><p>auto-complete のデフォルトの挙動は、<ul><li><code>TAB</code>一回で補完候補の共通部分を展開<li>以降は<code>TAB</code>連打で補完候補を上から順に選択 (<code>RET</code>で確定)</ul><p>となっています。さらに<code>ac-dwim</code>が有効になっている場合、最後の「<code>RET</code>で確定」も省略できます (<code>TAB</code>をただ連打しているだけでバシャバシャ補完される)。<p>company の場合、デフォルトの挙動は以下の設定で再現できます。<pre><code class="language-emacs-lisp">(global-set-key (kbd &quot;TAB&quot;) 'company-complete-common-or-cycle)
(push 'company-preview-common-frontend company-frontends)
</code></pre><p>が、<code>ac-dwim</code>時の挙動は company には実装されていません。<p>個人的にこの挙動はマストなので、 company さんに<code>ac-dwim</code>っぽく振る舞ってもらうためのプラグインを書きました。<p>https://github.com/zk-phi/company-dwim<hr><p>追記: company に付属している<code>company-tng</code>でも近い挙動を再現できることを教えてもらいました。「company には実装されていません」は調査不足でしたmm ただ、試してはみたものの理想の挙動とは異なっていたので、自分は引き続き<code>company-dwim</code>を使用しています (詳細は Readme 参照)<h2>company-anywhere</h2><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/2355ef17-d23c-befd-8e3b-1ea3de880846.gif"alt="middle.gif"><p>auto-complete はシンボルの途中部分を補完することもできました。<p>company にはこの挙動が実装されておらず、カーソルの直後に (空白以外の) 文字がある場合は補完が始まりません。<p>これもどうしても不便だったので、プラグインを書いてみました。使ってみたい方はこちらからどうぞ。<p>https://github.com/zk-phi/company-anywhere<h2>words-in-same-mode-buffers</h2><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/23868408-49b4-5853-6607-a808047c78c7.gif"alt="smb.gif"><p>auto-complete には words-in-same-mode-buffers という source (company でいう backend) があり、これが自分にはかなり使い勝手が良かったです。<p>これは「現在編集中のバッファ、またはそのバッファと同じメジャーモードになっているバッファ」から補完候補を探してきてくれるものです。 company の capf (<code>completion-at-point</code>) のように賢くはありませんが、むしろその素朴な挙動が予測可能な感じで結構好きでした。また fuzzy.el を入れることで、曖昧マッチに対応することもできました (<code>ac-use-fuzzy</code>)。<p>company の場合、 capf に対応しているメジャーモードであれば<code>completion-styles</code>をいじることで曖昧マッチには対応することができます。しかし、 capf 非対応のメジャーモード (dabbrev を使う) では曖昧マッチも利用できません。また対応しているメジャーモードでも動作がモタつくことがあるように感じました。<p>そこでこちらも words-in-same-mode-buffers に相当する感じの company backend を自前で実装してみました。<p>https://github.com/zk-phi/company-same-mode-buffers<p>補完候補の集め方は auto-complete の words-in-same-mode-buffers と同じで、あわせて以下のギミックも盛り込んでみました：<ul><li><code>completion-styles</code>のように、複数のマッチ戦略を選んでフォールバックできる<li>ファイルに補完候補をダンプして、次回起動時いきなり温まった状態から使える<li>補完候補の管理を線形リストではなくパトリシア木にして、補完候補が増えたときのモタつきを減らす</ul><p>auto-complete の「組み込みのキーワードも words-in-same-mode-buffers の候補もみんないっしょくたに出てくる」あの感じが好きだったので、<code>:with</code>に放り込んで補完候補をかさ増ししてみました。<pre><code class="language-emacs-lisp">(setq company-backends
      '(company-files
        (company-css :with company-same-mode-buffers)
        (company-keywords :with company-same-mode-buffers)
        company-same-mode-buffers))
</code></pre><p><code>:with</code>より手前の backend が失敗した場合は下の backend にフォールバックしてくれるみたいなので、そこを意識して設定するとちょっとパフォーマンスがよくなる感じがあります。<h2>まとめ</h2><p>そんなこんなで auto-complete の良かったところをそれなりに再現しながら、 company に移行することができました。</div></div><hr><p><a class="link"href="javascript:history.back()">&lt; 戻る</a></div><script>const lazyScripts=["/js/prefetch.js","/js/stalker.js","/js/activity.js"],lazyStyles=["/css/common.css","/css/stalker.css"]</script>