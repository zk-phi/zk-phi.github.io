<!doctypehtml><html lang="ja"><title>zk-phi の部屋 :: 最近の活動</title><meta charset="utf-8"><meta http-equiv="X-UA-Compatible"content="IE=edge"><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="description"content="zk-phi のホームページです"><link rel="preload"href="/fonts/DotGothic16-Regular.woff2"as="font"crossorigin><link rel="stylesheet"href="/css/font.css"><link rel="stylesheet"href="/css/common_critical.css"><link rel="stylesheet"href="/css/activity.css"><script defer src="/js/loader.js"></script><style></style><body id="body"><div id="content"><h1 id="title"><span class="rot">💻</span>最近の活動<span class="rot">💻</span></h1><p><a class="link"href="javascript:history.back()">&lt; 戻る</a><hr><div id="article"class="left"><h2 class="header">意味の色とカラーテーマ</h2><div class="right"><p>Qiita (2020/12/8)<a class="link"target="_blank"rel="noreferrer"href="https://qiita.com/zk_phi/items/9bc65ae7c309cf46467d">See original</a></div><div id="cdata"><p><a href="https://qiita.com/advent-calendar/2020/emacs">Emacs Advent Calendar 2020</a>の 9 日目の記事です。<p><a href="https://qiita.com/zk_phi/items/ec998eaff72989b05b0a">おととしの Advent Calendar</a>でカラーテーマについての話を書いたのですが、その後２年、実際に自分で使ってみて色々と考えが整理された＆実装も進化したので改めて紹介させてください。<p>当時の記事と重なる箇所もありますが、ご了承ください mm<h2>tl;dr</h2><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/35e246ef-15cd-cdd7-99d5-e9d11d2b3217.gif"alt="hoge.gif"><p>「色を持たない」カラーテーマによって、 Emacs の外観を簡単に、一貫性を保ってコントロールできるようにしました。<h2>カラーテーマの責務</h2><h3>Emacs の Basic Faces</h3><p>Emacs には Basic Faces と呼ばれる、いくつかの特別な face があります。<ul><li><code>default</code><li><code>bold</code><li><code>italic</code><li><code>bold-italic</code><li><code>underline</code><li><code>fixed-pitch</code><li><code>fixed-pitch-serif</code><li><code>variable-pitch</code><li><code>shadow</code><li><code>link</code><li><code>link-visited</code><li><code>highlight</code><li><code>match</code><li><code>isearch</code><li><code>lazy-highlight</code><li><code>error</code><li><code>warning</code><li><code>success</code></ul><p>マニュアルによれば、他の Face たちはこれら Basic Faces を継承して定義することが推奨されており、「Basic Faces をカスタマイズするだけで Emacs 全体をカスタマイズできる」ことを理想としているように読めます。<p>しかしその後リッチなテーマ機構が実装されたことなどからも、この思想には限界があったように思えます。<h3>なにがしんどいのか</h3><p>私の考える Emacs の face の問題 (限界) は以下の二点です：<ol><li><p>Basic Face が圧倒的に足りていないこと<li><p>「意味」の face と「見た目」の face が混在していること</ol><p>1 について、いろいろなパッケージがそれぞれ独自に、 Basic Faces を継承しない face を定義していることから、 Basic Faces は現実のアプリにはかなり不足していることがわかると思います。<p>たとえば組み込みのシンタックスハイライトですら大量に独自 face を定義しています:<ul><li><code>font-lock-comment-face</code><li><code>font-lock-comment-delimiter-face</code><li><code>font-lock-string-face</code><li><code>font-lock-doc-face</code><li><code>font-lock-keyword-face</code><li><code>font-lock-builtin-face</code><li><code>font-lock-function-name-face</code><li><code>font-lock-variable-name-face</code><li><code>font-lock-type-face</code><li><code>font-lock-constant-face</code><li><code>font-lock-warning-face</code><li><code>font-lock-negation-char-face</code><li><code>font-lock-preprocessor-face</code><li><code>font-lock-regexp-grouping-backslash</code><li><code>font-lock-regexp-grouping-construct</code></ul><p>さらに悪いことには、これらの face たちは「その見た目のためだけに」また別のパッケージでさまざまに利用されています。<p>たとえば Emacs でディレクトリを開いたときの画面 (<code>dired</code>) では、ディレクトリのパスが表示されるヘッダ行に<code>font-lock-type-face</code>が使われています。 face 名からして本来は「型の名前をハイライトするための face」だったものを、ここではその「見た目だけ」を拝借するために使用していると考えられます。<p>これが 2 の問題で、「名前が用途を表している face」を、見た目のためだけに用途外の場所で使用してしまうと、全体の一貫性がなくなってしまいやすく、結果的にカラーテーマの実装もしづらくなってしまうと感じます。<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/6326a149-30ed-da38-f724-10d24873e3d9.png"alt="スクリーンショット 2020-12-04 13.13.52.png"><p>たとえば<code>dired</code>に似た、たくさんの項目が並んだリスト状の画面を表示するための別のモード<code>tabulated-list-mode</code>では、ヘッダの表示に<code>tabulated-list-fake-header</code>というまた別の face が使われていて、これはこれで<code>font-lock-type-face</code>とは別の見た目をしていたりします。<h3>カラーテーマのもう一つの責務</h3><p>現状の Emacs では、このようなチグハグ状態をなんとかするのもカラースキームの責務になってしまっているように感じています。各々のパッケージが自由に独自 face を定義して、そのルールに一貫性があまりないので、カラーテーマ側であらゆるパッケージの face の色をいい感じに設定して回る必要があります。<p>たんにエディタの画面全体の色合いを衣替えしたいだけの場合、これはちょっと大変すぎかなと思います。<h2>elemental-theme の設計</h2><p>そこで私は、この「カラーテーマのもう一つの責務」だけを上手にこなして、カラーパレットの選定はユーザーに開いたままにしておく、「色を持たない」カラーテーマ elemental-theme を実装しました（便宜上、デフォルトのスタイルは定義されていますが）。<p>以下、その設計思想を紹介したいと思います。<h3>Elemental Faces</h3><p>elemental-theme はまず、「見た目だけ」を表す face を必要十分な数だけ定義します。<p>elemental-theme ではこれらを elemental (根本の, 要素の) face と呼んでいます。 Atomic Design の atoms みたいなイメージです。<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/ce1f2df5-5c7f-e55b-38f2-1a24098b7b89.png"alt="スクリーンショット 2020-12-04 19.56.33.png"><p>core<ul><li><code>default</code>(built-in)<li><code>cursor</code>(built-in)</ul><p>濃淡<ul><li><code>elemental-bright-bg-face</code><li><code>elemental-brighter-bg-face</code><li><code>elemental-bright-fg-face</code><li><code>elemental-dark-fg-face</code><li><code>elemental-darker-fg-face</code></ul><p>アクセント<ul><li><code>elemental-accent-fg-1-face</code><li><code>elemental-accent-fg-2-face</code><li><code>elemental-accent-fg-3-face</code><li><code>elemental-accent-fg-4-face</code></ul><p><strong>他のすべての face はこれらの elemental な face を継承して定義されるので、 elemental-theme で使われるスタイルはこれで全部です。</strong>逆に、ここを調整するだけで、 Emacs 全体の見た目を一貫性を保ってコントロールできるというのがこのカラーテーマのコンセプトになります。<p>このあたりはおととしの記事時点でも同じような考えでしたが、「必要十分な」face のセットという点については考察が進んで、実装も変わっています。<h4>命名について</h4><p>名前に<code>-fg-</code>とつく face は主に単語などのハイライトに、<code>-bg-</code>とつく face は主に一定の大きさを持ったエリア全体のハイライトに使われます。そのため、<code>-fg-</code>face には前景色を、<code>-bg-</code>face には背景色を設定するとうまくいくことが多いです。また<code>-fg-</code>と<code>-bg-</code>face は適宜組み合わせて使われるので、互いにコンフリクトしないようにする必要があります。<p>アクセント色については、<code>-1-</code>から順に高い頻度で使われます。たとえば、<code>accent-fg-1</code>にはそのカラーテーマのメインとなるアクセント色、ブランド色を適用するといい感じになることが多いです。<h4>色相 face</h4><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/40c77f01-19c9-1221-b1ca-f7ce8f562ca3.png"alt="スクリーンショット 2020-12-04 19.58.46.png"><p>一部の色については UI 上で特別な意味を持つことがある（たとえば、エラーは暖色系、成功は寒色系）ので、専用の face を設けています。色数を減らしたいテーマでは、他の elemental face に使われている色の中から適当な色を選んで選んで流用してもよいとしています。<ul><li><code>elemental-red-fg-face</code><li><code>elemental-blue-fg-face</code><li><code>elemental-green-fg-face</code><li><code>elemental-orange-fg-face</code></ul><h3>Semantic Faces</h3><p>elemental-theme は次に、「用途だけ」を表す face を必要十分な数だけ定義します。ここが一番大きなアップデートです。<p>elemental-theme ではこれらを semantic (意味的な) face と呼んでいます。<p>basic<ul><li><code>elemental-caution</code><li><code>elemental-diminished</code><li><code>elemental-highlight</code><li><code>elemental-inappropreate</code><li><code>elemental-incorrect</code><li><code>elemental-key</code><li><code>elemental-match</code><li><code>elemental-match-interactive</code><li><code>elemental-reference</code><li><code>elemental-selected</code></ul><p>増減、追加削除<ul><li><code>elemental-diff-added</code><li><code>elemental-diff-changed</code><li><code>elemental-diff-refine-added</code><li><code>elemental-diff-refine-changed</code><li><code>elemental-diff-refine-removed</code><li><code>elemental-diff-removed</code></ul><p>ファイル<ul><li><code>elemental-file-executable</code><li><code>elemental-file-name</code><li><code>elemental-file-special</code></ul><p>アラート<ul><li><code>elemental-indicator-error</code><li><code>elemental-indicator-info</code><li><code>elemental-indicator-success</code><li><code>elemental-indicator-warning</code></ul><p>階層構造<ul><li><code>elemental-level-1</code><li><code>elemental-level-2</code><li><code>elemental-level-3</code><li><code>elemental-level-4</code><li><code>elemental-stage-1</code><li><code>elemental-stage-higher</code><li><code>elemental-stage-negative</code></ul><p>マークアップ言語の構文<ul><li><code>elemental-markup-code</code><li><code>elemental-markup-table</code></ul><p>プログラミング言語の構文<ul><li><code>elemental-syntax-builtin</code><li><code>elemental-syntax-literal</code><li><code>elemental-syntax-symbol</code><li><code>elemental-syntax-type</code></ul><p>その他 UI 部品<ul><li><code>elemental-ui-component</code><li><code>elemental-ui-component-diminished</code><li><code>elemental-ui-component-transparent</code><li><code>elemental-ui-ghost</code><li><code>elemental-ui-prompt</code></ul><p>これらの face はすべて elemental face を継承して定義されており、ここで「見た目」のパレットと「意味」のパレットを分離しています。elemental-theme では、各パッケージの face に色を塗る際、 elemental face を直接使うことはいっさいせず、必ず「意味」のパレットから選ぶようにします。<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/666c652d-c665-260a-e9d9-277faa604ca0.png"alt="-consistency.png"><p>たとえば<code>region</code>(バッファの選択範囲)、<code>ido-first-match</code>(ミニバッファのメニューで選択されている項目)、<code>company-tooltip-selection</code>(選択されている補完候補) などはどれも「選択されている」という概念を表しているので、すべて<code>elemental-selected</code>semantic face を継承させます。<p>これは一貫性を保ちつつ対応パッケージを増やしていくために役立ちます。<p>また elemental-theme では semantic face のカスタマイズも禁止していないので、たとえば同じ意味を持つ要素の見た目をまとめて変更したい場合は、ユーザーはこのレイヤーに手を入れることもできます。<p>ところで semantic face は elemental face よりもたくさんあるので、いくつかの semantic face は同じ見た目になる場合があります。また対応プラグインを増やせば増やすほど、そのようなケースは増えていくと思われます。そこで elemental-theme では以下のポリシーで sematnic face を定義していくことにしています。<h4>1. 一貫性</h4><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/9015e276-a71a-e9a3-88bb-3863dbdaca5d.png"alt="-architecture.png"><p>同じ機能を持つ部分はすべて同じ見た目になるようにします。<p>もし新しいパッケージをサポートする際は、極力既存の「意味」のパレットから適切なものを選ぶようにします。ただし、 適切な「意味」の face がパレットにない場合は、無理に他のもので代用することはせず、新たに追加することにします。<h4>2. 区別できること</h4><p>同じ見た目の要素が異なる機能を持つことを、次の場合に限って認めます: それらが同じバッファや UI 部品の中で使われない場合。<p>たとえば<code>elemental-markup-table</code>と<code>elemental-syntax-literal</code>は（デフォルトでは）同じ見た目をしています。これらはそれぞれ「マークアップ言語 (markdown, org など) の表」と「プログラミング言語の定数」をハイライトするために使われる face なので、一つのバッファに同時に出現することはありません。したがって、これらは同じ見た目をしていても問題ありません。<p>一方、たとえば<code>elemental-markup-code</code>(マークアップ言語の引用・コード部分) を<code>elemental-markup-table</code>と同じ見た目にするのはまずいです。なぜなら、どちらもマークアップ言語のシンタックスハイライトに使用されるので、同じ見た目をしていると区別できなくなってしまいます。<h2>まとめ</h2><p>face に「見た目」と「意味」それぞれの抽象化レイヤーを導入することで、 Emacs の face 周りのツラみを解決しようとしてみました。またその仕組みをいい感じに維持するための運用ポリシーを考えてみました。<p>今のところ快適に使えているので、よかったら試してみてください！ (アイデアだけ他のカラーテーマに援用するのも歓迎です)<p>https://github.com/zk-phi/elemental-theme<h3>おまけ</h3><p>elemental-theme はカラーテーマジェネレータではなく「継承関係のよく整理されたただのカラーテーマ」なので、<code>set-face-foreground</code>などでリアルタイムにいじることもできます。<p>悪用するとゲーミング Emacs (？) などもつくれます<p>&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;ゲーミング LISP かなり最悪感ある &lt;a href=&quot;https://t.co/2anF9gnY1X&quot;&gt;pic.twitter.com/2anF9gnY1X&lt;/a&gt;&lt;/p&gt;— ぜろけー🎄 (@zk_phi) &lt;a href=&quot;https://twitter.com/zk_phi/status/1329397402445352960?ref_src=twsrc%5Etfw&quot;&gt;November 19, 2020&lt;/a&gt;&lt;/blockquote&gt; &lt;script async src=&quot;https://platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;</div></div><hr><p><a class="link"href="javascript:history.back()">&lt; 戻る</a></div><script>const lazyScripts=["/js/prefetch.js","/js/stalker.js","/js/activity.js"],lazyStyles=["/css/common.css","/css/stalker.css"]</script>