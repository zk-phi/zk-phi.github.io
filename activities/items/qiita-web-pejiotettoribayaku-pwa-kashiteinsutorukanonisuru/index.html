<!doctypehtml><html lang="ja"><title>zk-phi の部屋 :: 最近の活動</title><meta charset="utf-8"><meta name="viewport"content="initial-scale=1"><meta name="description"content="zk-phi のホームページです"><link rel="preload"href="/fonts/DotGothic16-Regular.woff"as="font"crossorigin><link rel="stylesheet"href="/css/font.css"><link rel="stylesheet"href="/css/common_critical.css"><link rel="stylesheet"href="/css/activity.css"><script defer src="/js/loader.js"></script><style></style><body id="body"><div id="content"><h1 id="title"><span class="rot">💻</span>最近の活動<span class="rot">💻</span></h1><p><a class="link"href="javascript:history.back()">&lt; 戻る</a><hr><div id="article"class="left"><h2>Web ページを手っ取り早く PWA 化してインストール可能にする</h2><div class="right"><p>Qiita (2021/11/20)<a class="link"target="_blank"rel="noreferrer"href="https://qiita.com/zk_phi/items/34a7a6ac4f3ac478c814">See original</a></div><div id="cdata"><p>Web ページをアプリとしてインストール (ホーム画面に追加) できるようにするまでの、イージーモードな手順です。<h2>アイコン画像を用意する</h2><p>アイコン画像は、複数のバリエーションを用意することもできますが、「<code>144x144</code>以上の<code>png</code>１枚」が最低限必要です。<h2>manifest.json を用意する</h2><p>PWA には、アプリケーションの情報をおさめた<code>manifest.json</code>が必須です。最低限の内容はこんな感じになります：<pre><code class="language-json">{
  &quot;name&quot;: &quot;&lt;アプリ名&gt;&quot;,
  &quot;short_name&quot;: &quot;&lt;短いアプリ名&gt;&quot;,
  &quot;icons&quot;: [{
    &quot;src&quot;: &quot;icon.png&quot;,
    &quot;sizes&quot;: &quot;144x144&quot;,
    &quot;type&quot;: &quot;image/png&quot;
  }],
  &quot;start_url&quot;: &quot;/&quot;,
  &quot;display&quot;: &quot;fullscreen&quot;
}
</code></pre><p><code>display</code>は必須ではありませんが、設定しないと普通にブラウザ画面で表示されてしまってアプリ感が出ません。<h2>サービスワーカーを生成する</h2><p>サービスワーカーは主にアプリをキャッシュして、オフライン時でも動くようにするためのプログラムです (その他、プッシュ通知のやりとりとかもろもろのバックグラウンド処理をやらせることもできます)。<p>Web ページの PWA 化には必須ですが、最低限のものは<code>workbox</code>という CLI ツールで生成できるのでここでは自動生成してしまいます。<p><code>workbox</code>をインストールして、<pre><code>npm install workbox-cli
</code></pre><p>ウィザードで設定ファイルを生成します。<pre><code>npx workbox wizard
</code></pre><p>キャッシュしたいファイル形式にチェックを入れたりするだけで設定ファイル<code>workbox-config.js</code>が生えます。<p>設定ファイルを用意したら<code>generateSW</code>コマンドで実際のサービスワーカーを生成できます。<pre><code>npx workbox generateSW workbox-config.js
</code></pre><p>デフォルト設定だと<code>sw.js</code>という名前で生成されると思います。<p><code>sw.js</code>にはキャッシュすべきファイル名がベタ書きされているので、アプリの構成が変わった時は更新する必要があります。<p><code>husky</code>や GitHub Actions などで push するたびに自動更新するようにしておくと便利かもしれません。<h2>manifest.json とサービスワーカーを読み込む</h2><p>最後に、 PWA 化したい Web ページで<code>manifest.json</code>とサービスワーカーを読み込みます。<pre><code class="language-html">&lt;link rel=&quot;manifest&quot; href=&quot;manifest.json&quot;&gt;
&lt;script&gt;
  if (&quot;serviceWorker&quot; in navigator) {
    navigator.serviceWorker.register(&quot;sw.js&quot;);
  }
&lt;/script&gt;
</code></pre><h2>動作確認とトラブルシュート</h2><p>PWA の動作確認には Web サーバー (https または localhost) が必要です。適当に Web サーバーを立ち上げて、ページを開いてみてください。<p>僕はエディタから簡易 Web サーバーを立ち上げられるようにしています (https://github.com/skeeto/emacs-web-server)。<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/2203e57a-4cb1-6379-a7da-93f613ab5308.png"alt="スクリーンショット 2021-11-20 18.02.19.png"><p>URL 欄にインストールボタンが出ていれば無事動いています。<p>インストールボタンが出ない場合は、デベロッパーツールの<code>Application</code>タブを開くと、サービスワーカーの動作状況や<code>manifest.json</code>　の問題を見ることができます。<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/54240/15109f4f-6ff0-fec2-f163-3f111ccc14c9.png"alt="スクリーンショット 2021-11-20 18.05.02.png"><p>「アイコンの画像サイズが<code>144x144</code>になってないよ」とかで怒られてるケースが多いと思います。<h2>おまけ：インストールを促す</h2><p>アプリがインストール可能な状態になると<code>beforeinstallprompt</code>イベントが発行されるので、これにフックすると独自のダイアログでインストールを促すことができます。<pre><code class="language-js">let installEvt;
window.addEventListener('beforeinstallprompt', (e) =&gt; {
  installEvt = e;
  e.preventDefault();
  showInstallDialog();
});
</code></pre><p>このとき、イベントのオブジェクトを保存 (<code>installEvt</code>) しておくと、後で<code>.prompt</code>メソッドを呼ぶことで実際にインストールさせることもできます (<code>prompt</code>の名前の通り、ユーザーはキャンセルすることもできます)。<pre><code class="language-js">installButton.onclick = () =&gt; installEvt.prompt();
</code></pre></div></div><hr><p><a class="link"href="javascript:history.back()">&lt; 戻る</a></div><script>const lazyScripts=["/js/prefetch.js","/js/stalker.js","/js/activity.js"],lazyStyles=["/css/common.css","/css/stalker.css"]</script>